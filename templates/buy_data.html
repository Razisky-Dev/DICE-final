{% extends 'dashboard_layout.html' %}

{% block title %}Buy Data | RazilHub{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex align-items-end justify-content-between mb-4">
    <div>
        <h2 class="fw-bold text-dark mb-1">Buy Data ðŸ“¶</h2>
        <p class="text-muted mb-0">Purchase affordable data bundles instantly</p>
    </div>
</div>

<!-- Wallet Summary Cards -->
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card stat-card bg-gradient-primary text-white h-100 border-0 shadow-sm rounded-4">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div class="p-2 bg-white bg-opacity-25 rounded-3">
                        <i class="bi bi-wallet2 fs-4 text-white"></i>
                    </div>
                </div>
                <h6 class="card-subtitle text-white text-opacity-75 mb-1">Wallet Balance</h6>
                <h3 class="fw-bold mb-0">GHâ‚µ{{ "{:,.2f}".format(balance) }}</h3>
                <a href="{{ url_for('wallet') }}"
                    class="btn btn-sm btn-light text-primary rounded-pill mt-3 px-3 fw-bold">
                    <i class="bi bi-plus-circle me-1"></i> Top Up
                </a>
            </div>
        </div>
    </div>

    <!-- Stats placeholders if needed, otherwise just design elements -->
    <div class="col-md-4">
        <div class="card stat-card bg-success text-white h-100 border-0 shadow-sm rounded-4">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div class="p-2 bg-white bg-opacity-25 rounded-3">
                        <i class="bi bi-bag-check fs-4 text-white"></i>
                    </div>
                </div>
                <h6 class="card-subtitle text-white text-opacity-75 mb-1">Total Orders</h6>
                <h3 class="fw-bold mb-0">{{ transactions|length }}</h3>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card stat-card bg-warning text-white h-100 border-0 shadow-sm rounded-4">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div class="p-2 bg-white bg-opacity-25 rounded-3">
                        <i class="bi bi-clock-history fs-4 text-white"></i>
                    </div>
                </div>
                <h6 class="card-subtitle text-white text-opacity-75 mb-1">Recent Activity</h6>
                {% if transactions %}
                <p class="text-white text-opacity-90 small mb-0">{{ transactions[0].description or 'Latest transaction'
                    }}</p>
                {% else %}
                <p class="text-white text-opacity-75 small mb-0">No recent transactions</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Buy Data Section -->
<div class="card border-0 bg-white shadow-sm p-4 rounded-4">
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-4 gap-3">
        <div>
            <h4 class="fw-bold text-dark mb-1">Select Network</h4>
            <p class="text-muted small mb-0">Choose your preferred network to view bundles</p>
        </div>

        <!-- Network Tabs -->
        <ul class="nav nav-pills network-tabs bg-light rounded-pill p-1 d-inline-flex" role="tablist">
            <li class="nav-item">
                <button class="nav-link active mtn-tab" data-bs-toggle="pill" data-bs-target="#mtn">MTN</button>
            </li>
            <li class="nav-item">
                <button class="nav-link telecel-tab" data-bs-toggle="pill" data-bs-target="#telecel">TELECEL</button>
            </li>
            <li class="nav-item">
                <button class="nav-link airteltigo-tab" data-bs-toggle="pill"
                    data-bs-target="#airteltigo">AIRTELTIGO</button>
            </li>
        </ul>
    </div>

    <!-- Tab Content -->
    <div class="tab-content mt-2">
        <!-- MTN -->
        <div class="tab-pane fade show active" id="mtn">
            <div class="row g-3">
                {% for plan in data_bundles["MTN"] %}
                <div class="col-6 col-md-4 col-lg-3">
                    <div class="package-card mtn p-3 h-100 d-flex flex-column text-center">
                        <span class="badge bg-warning text-dark rounded-pill px-3">Non Expiry Bundle</span>
                        <h3 class="fw-bold text-dark mb-1">{{ plan.plan_size }}</h3>
                        <h5 class="price-tag mb-0">
                            <span class="price-currency">GHS</span> {{ plan.selling_price }}
                        </h5>
                        <div class="mt-3 pt-3 border-top border-light mt-auto">
                            <button class="btn btn-warning w-100 fw-bold rounded-pill"
                                onclick="openPurchaseModal('{{ plan.id }}', '{{ plan.network }}', '{{ plan.plan_size }}', '{{ plan.selling_price }}')">Buy
                                Now</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- TELECEL -->
        <div class="tab-pane fade" id="telecel">
            <div class="row g-3">
                {% for plan in data_bundles["TELECEL"] %}
                <div class="col-6 col-md-4 col-lg-3">
                    <div class="package-card telecel p-3 h-100 d-flex flex-column text-center">
                        <div class="mb-2">
                            <span class="badge bg-danger rounded-pill px-3">Non Expiry Bundle</span>
                        </div>
                        <h3 class="fw-bold text-dark mb-1">{{ plan.plan_size }}</h3>
                        <h5 class="price-tag mb-0">
                            <span class="price-currency">GHS</span> {{ plan.selling_price }}
                        </h5>
                        <div class="mt-3 pt-3 border-top border-light mt-auto">
                            <button class="btn btn-danger w-100 fw-bold rounded-pill"
                                onclick="openPurchaseModal('{{ plan.id }}', '{{ plan.network }}', '{{ plan.plan_size }}', '{{ plan.selling_price }}')">Buy
                                Now</button>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="col-12">
                    <div class="text-center py-5 bg-light rounded-4 border border-dashed">
                        <i class="bi bi-wifi-off fs-1 text-muted opacity-50 mb-3 d-block"></i>
                        <h6 class="text-muted fw-bold">No Telecel packages available</h6>
                        <p class="small text-muted mb-0">Check back later for updates</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- AIRTELTIGO -->
        <div class="tab-pane fade" id="airteltigo">
            <div class="row g-3">
                {% for plan in data_bundles["AIRTELTIGO"] %}
                <div class="col-6 col-md-4 col-lg-3">
                    <div class="package-card airteltigo p-3 h-100 d-flex flex-column text-center">
                        <div class="mb-2">
                            <span class="badge bg-primary rounded-pill px-3">Non Expiry Bundle</span>
                        </div>
                        <h3 class="fw-bold text-dark mb-1">{{ plan.plan_size }}</h3>
                        <h5 class="price-tag mb-0">
                            <span class="price-currency">GHS</span> {{ plan.selling_price }}
                        </h5>
                        <div class="mt-3 pt-3 border-top border-light mt-auto">
                            <button class="btn btn-primary w-100 fw-bold rounded-pill"
                                onclick="openPurchaseModal('{{ plan.id }}', '{{ plan.network }}', '{{ plan.plan_size }}', '{{ plan.selling_price }}')">Buy
                                Now</button>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="col-12">
                    <div class="text-center py-5 bg-light rounded-4 border border-dashed">
                        <i class="bi bi-wifi-off fs-1 text-muted opacity-50 mb-3 d-block"></i>
                        <h6 class="text-muted fw-bold">No AirtelTigo packages available</h6>
                        <p class="small text-muted mb-0">Check back later for updates</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block modals %}
<!-- Purchase Confirmation Modal -->
<div class="modal fade" id="purchaseModal" tabindex="-1" aria-hidden="true" style="z-index: 10055 !important;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Confirm Purchase</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <span id="modalNetworkBadge"
                        class="badge rounded-pill bg-light text-dark mb-2 px-3 py-2 border">NETWORK</span>
                    <h3 class="fw-bold mb-0" id="modalPlanSize">1 GB</h3>
                    <p class="text-muted small">Data Bundle</p>
                    <h2 class="text-primary fw-bold display-6 mb-0">GHâ‚µ <span id="modalPrice">0.00</span></h2>
                </div>

                <form id="purchaseForm">
                    <div class="mb-3">
                        <label for="purchasePhone" class="form-label fw-bold small text-uppercase text-muted">Phone
                            Number associated with this purchase</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-0"><i class="bi bi-phone"></i></span>
                            <input type="tel" class="form-control bg-light border-0 p-3" id="purchasePhone"
                                placeholder="024XXXXXXX" required pattern="[0-9]{10}" maxlength="10">
                        </div>
                        <div class="form-text">Ensure this is the correct number to receive the data.</div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow-sm"
                        id="confirmBtn">
                        <span id="btnText">Confirm Payment</span>
                        <span id="btnSpinner" class="spinner-border spinner-border-sm d-none" role="status"
                            aria-hidden="true"></span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedPlan = null;
    const purchaseModal = new bootstrap.Modal(document.getElementById('purchaseModal'));

    function openPurchaseModal(id, network, size, price) {
        selectedPlan = { id, network, size, price };

        // Update Modal UI
        document.getElementById('modalPlanSize').textContent = size;
        document.getElementById('modalPrice').textContent = parseFloat(price).toFixed(2);

        const badge = document.getElementById('modalNetworkBadge');
        badge.textContent = network;

        // Remove old classes
        badge.className = 'badge rounded-pill mb-2 px-3 py-2 border';

        // Add new class based on network
        if (network === 'MTN') {
            badge.classList.add('bg-warning', 'text-dark');
        } else if (network === 'TELECEL') {
            badge.classList.add('bg-danger', 'text-white');
        } else {
            badge.classList.add('bg-primary', 'text-white');
        }

        // Show Modal
        purchaseModal.show();
    }

    // Ensure modal is at the end of body to avoid stacking context issues
    document.addEventListener('DOMContentLoaded', function () {
        const modalEl = document.getElementById('purchaseModal');
        if (modalEl) {
            document.body.appendChild(modalEl);
        }

        // Cleanup any stuck backdrops
        const backdrops = document.querySelectorAll('.modal-backdrop');
        if (backdrops.length > 0) {
            backdrops.forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }
    });

    document.getElementById('purchaseForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        if (!selectedPlan) return;

        const phoneInput = document.getElementById('purchasePhone');
        const phone = phoneInput.value;
        const btn = document.getElementById('confirmBtn');
        const btnText = document.getElementById('btnText');
        const spinner = document.getElementById('btnSpinner');

        // Loading State
        btn.disabled = true;
        btnText.textContent = "Processing...";
        spinner.classList.remove('d-none');

        try {
            const response = await fetch('/api/purchase_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': "{{ csrf_token() }}"
                },
                body: JSON.stringify({
                    plan_id: selectedPlan.id,
                    network: selectedPlan.network,
                    phone: phone
                })
            });

            const result = await response.json();

            if (result.success) {
                alert("Success! " + result.message);
                location.reload();
            } else {
                alert("Error: " + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert("An error occurred. Please try again.");
        } finally {
            // Reset State
            btn.disabled = false;
            btnText.textContent = "Confirm Payment";
            spinner.classList.add('d-none');
            purchaseModal.hide();
        }
    });
</script>
{% endblock %}
```