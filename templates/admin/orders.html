{% extends 'admin/base.html' %}

{% block title %}Manage Orders | Admin{% endblock %}
{% block header_title %}Manage Orders{% endblock %}
{% block header_subtitle %}View and update customer orders{% endblock %}

{% block content %}
<div class="card border-0 shadow-sm bg-white">
    <style>
        .modal-backdrop {
            z-index: 20000 !important;
        }

        .modal {
            z-index: 20001 !important;
        }

        /* Ensure inputs are selectable */
        .modal-dialog {
            pointer-events: auto !important;
        }
    </style>
    <div
        class="card-header bg-white border-0 py-3 px-4 d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
        <h5 class="fw-bold mb-0 text-dark text-center w-100">All Orders (v5: Inline Edit)</h5>

        <div class="d-flex gap-2">
            <!-- Filter Form -->
            <!-- Search Filter -->
            <form id="searchForm" action="{{ url_for('admin_orders') }}" method="GET" class="d-none">
                <input type="hidden" name="search" id="searchInput">
                <input type="hidden" name="network" value="{{ request.args.get('network', '') }}">
                <input type="hidden" name="status" value="{{ request.args.get('status', '') }}">
            </form>

            <div class="d-flex align-items-center">
                <button type="button"
                    class="btn btn-light shadow-sm rounded-circle d-flex align-items-center justify-content-center"
                    style="width: 38px; height: 38px;" onclick="showSearchPopup()">
                    <i class="bi bi-search text-primary"></i>
                </button>
            </div>

            <select name="network" class="form-select form-select-sm bg-light border-0" onchange="this.form.submit()">
                <option value="">All Networks</option>
                <option value="MTN" {% if request.args.get('network')=='MTN' %}selected{% endif %}>MTN</option>
                <option value="TELECEL" {% if request.args.get('network')=='TELECEL' %}selected{% endif %}>Telecel
                </option>
                <option value="AIRTELTIGO" {% if request.args.get('network')=='AIRTELTIGO' %}selected{% endif %}>
                    AirtelTigo</option>
            </select>

            <select name="status" class="form-select form-select-sm bg-light border-0" onchange="this.form.submit()">
                <option value="">All Statuses</option>
                <option value="Pending" {% if request.args.get('status')=='Pending' %}selected{% endif %}>Pending
                </option>
                <option value="Processing" {% if request.args.get('status')=='Processing' %}selected{% endif %}>
                    Processing</option>
                <option value="Delivered" {% if request.args.get('status')=='Delivered' %}selected{% endif %}>
                    Delivered</option>
                <option value="Failed" {% if request.args.get('status')=='Failed' %}selected{% endif %}>Failed
                </option>
            </select>
            </form>

            <a href="{{ url_for('admin_export_orders', status=request.args.get('status'), network=request.args.get('network')) }}"
                class="btn btn-sm btn-success fw-bold">
                <i class="bi bi-file-earmark-spreadsheet me-1"></i> Export Excel
            </a>
        </div>
    </div>

    <!-- Removed table-responsive class to show full width without scroll if space allows -->
    <!-- Removed table-responsive class to show full width without scroll if space allows -->
    <form action="{{ url_for('admin_orders') }}" method="POST" id="bulkForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action_type" value="update_status">

        <!-- Bulk Actions Toolbar -->
        <div class="card bg-light border-0 mb-3">
            <div class="card-body py-2">
                <div class="row align-items-center g-2 justify-content-center justify-content-md-start">
                    <div class="col-auto">
                        <span class="fw-bold text-muted small">Bulk Actions:</span>
                    </div>
                    <div class="col-auto">
                        <select name="new_status" class="form-select form-select-sm" required>
                            <option value="" selected disabled>Change Status To...</option>
                            <option value="Pending">Pending</option>
                            <option value="Processing">Processing</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Failed">Failed</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-sm btn-dark"
                            onclick="return confirm('Update status for selected orders?')">
                            Apply Update
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 text-center text-nowrap" style="min-width: 900px;">
                <thead class="bg-light text-muted text-center">
                    <tr>
                        <th style="width: 40px;" class="ps-4 text-center">
                            <input type="checkbox" class="form-check-input" id="selectAll">
                        </th>
                        <th class="border-0 text-uppercase small fw-bold text-center">ID</th>
                        <th class="border-0 text-uppercase small fw-bold text-center">User</th>
                        <th class="border-0 text-uppercase small fw-bold text-center">Package</th>
                        <th class="border-0 text-uppercase small fw-bold text-center">Amount</th>
                        <th class="border-0 text-uppercase small fw-bold text-center">To</th>
                        <th class="border-0 text-uppercase small fw-bold text-center">Status</th>
                        <th class="pe-4 border-0 text-uppercase small fw-bold text-center">Date</th>
                    </tr>
                </thead>
                <tbody class="text-center">
                    {% for order in orders.items %}
                    <tr>
                        <td class="ps-4 text-center">
                            <input type="checkbox" class="form-check-input order-checkbox" name="order_ids"
                                value="{{ order.id }}">
                        </td>
                        <td class="text-center">
                            <div class="fw-bold text-dark">{{ order.transaction_id }}</div>
                        </td>
                        <td class="text-center">
                            <div class="d-flex align-items-center justify-content-center">
                                <div class="avatar-initials bg-primary bg-opacity-10 text-primary rounded-circle me-2 fw-bold d-flex align-items-center justify-content-center"
                                    style="width:30px; height:30px; font-size: 0.8rem;">
                                    {{ order.user.first_name[0] | default('U') }}
                                </div>
                                <div class="fw-bold text-dark small">{{ order.user.username }}</div>
                            </div>
                        </td>
                        <td>
                            <span class="badge 
                                {% if order.network == 'MTN' %}bg-warning text-dark
                                {% elif order.network == 'TELECEL' %}bg-danger
                                {% else %}bg-primary{% endif %} 
                                bg-opacity-10 
                                {% if order.network == 'MTN' %}border-warning{% elif order.network == 'TELECEL' %}border-danger{% else %}border-primary{% endif %}
                                border border-opacity-25 rounded-pill" style="font-size: 0.7rem;">
                                {{ order.network }}
                            </span>
                            <div class="small fw-bold mt-1">{{ order.package }}</div>
                        </td>
                        <td class="fw-bold text-dark">GHâ‚µ {{ "{:,.2f}".format(order.amount) }}</td>
                        <td class="small fw-bold">{{ order.phone }}</td>
                        <td>
                            <!-- Used a div wrapper for status badge instead of direct form to avoid nesting forms -->
                            <!-- But wait, previous design had per-row update form. 
                                  If we wrap the whole table in a form, we CANNOT have nested forms.
                                  We must remove the per-row form and just show the status badge or a link.
                                  However, the bulk action replaces the need for per-row inline editing often, 
                                  OR we can use JS to submit the individual update.
                                  Simplest: Keep per-row update as a separate miniature form? NO, nested forms are illegal HTML.
                                  Solution: Move per-row update to a modal OR just use bulk update OR make the per-row selector trigger a JS submit that uses a hidden form outside the table.
                                  
                                  For now, to strictly follow HTML rules, I will REPLACE the inline form with just a status badge/text, 
                                  since Bulk Action is the requested feature. 
                                  OR, better UX: use a standalone dropdown that submits via JS (AJAX) or triggers a hidden form.
                                  
                                  Actually, the simplest reliable way for now is to just show the status. 
                                  If they want to update one, they click the checkbox and use the bulk tool.
                                  This cleans up the UI significantly.
                             -->
                            <span class="badge 
                                {% if order.status == 'Delivered' or order.status == 'Success' %}bg-success-subtle text-success
                                {% elif order.status == 'Pending' %}bg-warning-subtle text-warning
                                {% elif order.status == 'Processing' %}bg-info-subtle text-info
                                {% else %}bg-danger-subtle text-danger{% endif %} rounded-pill px-3">
                                {{ order.status }}
                            </span>
                        </td>
                        <td class="pe-4 small text-muted">
                            {{ order.date.strftime('%Y-%m-%d') }}<br>
                            {{ order.date.strftime('%H:%M') }}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-5">
                            <i class="bi bi-box-seam fs-1 d-block mb-3 opacity-25"></i>
                            No orders found matching your criteria.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>

    <!-- Pagination -->
    {% if orders.pages > 1 %}
    <div class="card-footer bg-white border-0 py-3">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mb-0">
                <li class="page-item {% if not orders.has_prev %}disabled{% endif %}">
                    <a class="page-link border-0"
                        href="{{ url_for('admin_orders', page=orders.prev_num, status=request.args.get('status'), network=request.args.get('network')) }}">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
                {% for page_num in orders.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=1) %}
                {% if page_num %}
                <li class="page-item {% if page_num == orders.page %}active{% endif %}">
                    <a class="page-link border-0 rounded-circle mx-1 d-flex align-items-center justify-content-center"
                        style="width: 32px; height: 32px;"
                        href="{{ url_for('admin_orders', page=page_num, status=request.args.get('status'), network=request.args.get('network')) }}">
                        {{ page_num }}
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled"><span class="page-link border-0">...</span></li>
                {% endif %}
                {% endfor %}
                <li class="page-item {% if not orders.has_next %}disabled{% endif %}">
                    <a class="page-link border-0"
                        href="{{ url_for('admin_orders', page=orders.next_num, status=request.args.get('status'), network=request.args.get('network')) }}">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    function showSearchPopup() {
        ByteSwal.fire({
            title: 'Search Orders',
            text: 'Enter Transaction ID or Phone Number',
            input: 'text',
            inputPlaceholder: 'e.g. byt..., 054...',
            showCancelButton: true,
            confirmButtonText: 'Search',
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            preConfirm: (value) => {
                if (!value) {
                    Swal.showValidationMessage('Please enter a value')
                }
                return value
            }
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('searchInput').value = result.value;
                document.getElementById('searchForm').submit();
            }
        });
    }

    // Select All Checkboxes Logic
    document.getElementById('selectAll').addEventListener('change', function () {
        var checkboxes = document.querySelectorAll('.order-checkbox');
        for (var checkbox of checkboxes) {
            checkbox.checked = this.checked;
        }
    });
</script>
{% endblock %}